---
description: 扩展UI开发规范和最佳实践
globs: *.html,options.js,history.js
---

# 扩展 UI 开发规范

## HTML 页面结构

### 标准页面结构

参考 [smart-search-extension/options.html](mdc:smart-search-extension/options.html) 和 [smart-search-extension/history.html](mdc:smart-search-extension/history.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>页面标题</title>
  <style>
    /* 页面样式 */
  </style>
</head>
<body>
  <div class="container">
    <!-- 页面内容 -->
  </div>
  
  <script type="module" src="script.js"></script>
</body>
</html>
```

### HTML 最佳实践

✅ **推荐做法**：

```html
<!-- 使用语义化标签 -->
<header>
  <h1>标题</h1>
</header>

<main>
  <section>
    <h2>章节标题</h2>
    <article>内容</article>
  </section>
</main>

<footer>
  <p>页脚信息</p>
</footer>

<!-- 使用有意义的 class 和 id -->
<button id="saveButton" class="btn btn-primary">保存</button>

<!-- 表单元素关联 label -->
<label for="enableFeature">
  <input type="checkbox" id="enableFeature">
  启用功能
</label>
```

❌ **不推荐做法**：

```html
<!-- 不要使用无意义的标签 -->
<div>
  <div>
    <div>内容</div>
  </div>
</div>

<!-- 不要使用内联样式和脚本 -->
<button onclick="doSomething()" style="color: red;">点击</button>

<!-- 不要使用已废弃的标签 -->
<font color="red">文本</font>
<center>居中内容</center>
```

## CSS 样式规范

### 命名规范

使用 BEM (Block Element Modifier) 命名：

```css
/* Block */
.settings-panel { }

/* Element */
.settings-panel__item { }
.settings-panel__title { }

/* Modifier */
.settings-panel--collapsed { }
.settings-panel__item--active { }
```

### 样式组织

```css
/* 1. 布局属性 */
.container {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

/* 2. 视觉属性 */
.button {
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
}

/* 3. 文字属性 */
.title {
  font-size: 24px;
  font-weight: 600;
  line-height: 1.5;
}

/* 4. 其他属性 */
.animated {
  transition: all 0.3s ease;
  cursor: pointer;
}
```

### 响应式设计

```css
/* 移动优先 */
.container {
  padding: 10px;
}

/* 平板 */
@media (min-width: 768px) {
  .container {
    padding: 20px;
  }
}

/* 桌面 */
@media (min-width: 1024px) {
  .container {
    padding: 30px;
  }
}
```

### 颜色和主题

定义统一的颜色变量：

```css
:root {
  /* 主色调 */
  --primary-color: #4CAF50;
  --primary-hover: #45a049;
  --primary-active: #3d8b40;
  
  /* 次要颜色 */
  --secondary-color: #2196F3;
  --success-color: #4CAF50;
  --danger-color: #f44336;
  --warning-color: #ff9800;
  --info-color: #2196F3;
  
  /* 中性色 */
  --text-color: #333;
  --text-muted: #666;
  --border-color: #ddd;
  --bg-color: #f9f9f9;
  
  /* 间距 */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* 圆角 */
  --border-radius: 4px;
  
  /* 阴影 */
  --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* 使用变量 */
.button {
  background-color: var(--primary-color);
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.button:hover {
  background-color: var(--primary-hover);
}
```

### 深色模式支持

```css
/* 浅色模式（默认） */
:root {
  --bg-color: #ffffff;
  --text-color: #333333;
  --border-color: #dddddd;
}

/* 深色模式 */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-color: #1e1e1e;
    --text-color: #e0e0e0;
    --border-color: #444444;
  }
}

/* 使用 */
body {
  background-color: var(--bg-color);
  color: var(--text-color);
}
```

## JavaScript UI 操作

### DOM 操作最佳实践

✅ **推荐做法**：

```javascript
// 使用 querySelector
const button = document.querySelector('#saveButton');
const items = document.querySelectorAll('.list-item');

// 使用事件委托
document.querySelector('.list').addEventListener('click', (e) => {
  if (e.target.matches('.delete-btn')) {
    deleteItem(e.target.dataset.id);
  }
});

// 批量更新 DOM（使用 DocumentFragment）
const fragment = document.createDocumentFragment();
items.forEach(item => {
  const li = document.createElement('li');
  li.textContent = item.name;
  fragment.appendChild(li);
});
list.appendChild(fragment);

// 避免重排
const element = document.querySelector('.element');
element.style.cssText = 'width: 100px; height: 100px; color: red;';
```

❌ **不推荐做法**：

```javascript
// 不要在循环中操作 DOM
items.forEach(item => {
  const li = document.createElement('li');
  li.textContent = item.name;
  list.appendChild(li); // 每次都触发重排！
});

// 不要多次读写样式
element.style.width = '100px';
element.style.height = '100px';
element.style.color = 'red';
```

### 表单处理

```javascript
// 获取表单数据
function getFormData() {
  const formData = {
    enableFeature: document.querySelector('#enableFeature').checked,
    apiKey: document.querySelector('#apiKey').value.trim(),
    maxResults: parseInt(document.querySelector('#maxResults').value) || 10
  };
  
  return formData;
}

// 验证表单
function validateForm(data) {
  const errors = [];
  
  if (!data.apiKey) {
    errors.push('API Key 不能为空');
  }
  
  if (data.maxResults < 1 || data.maxResults > 100) {
    errors.push('最大结果数必须在 1-100 之间');
  }
  
  return errors;
}

// 显示错误
function showErrors(errors) {
  const errorContainer = document.querySelector('#errors');
  errorContainer.innerHTML = errors
    .map(err => `<div class="error">${err}</div>`)
    .join('');
  errorContainer.style.display = 'block';
}

// 保存配置
async function saveSettings() {
  const data = getFormData();
  const errors = validateForm(data);
  
  if (errors.length > 0) {
    showErrors(errors);
    return;
  }
  
  try {
    await chrome.storage.sync.set(data);
    showSuccess('设置已保存');
  } catch (error) {
    showError('保存失败: ' + error.message);
  }
}
```

### 加载状态处理

```javascript
// 显示加载中
function showLoading(message = '加载中...') {
  const loading = document.createElement('div');
  loading.id = 'loading';
  loading.className = 'loading-overlay';
  loading.innerHTML = `
    <div class="loading-spinner"></div>
    <div class="loading-message">${message}</div>
  `;
  document.body.appendChild(loading);
}

// 隐藏加载中
function hideLoading() {
  const loading = document.querySelector('#loading');
  if (loading) {
    loading.remove();
  }
}

// 使用示例
async function loadData() {
  showLoading('正在加载数据...');
  
  try {
    const data = await fetchData();
    renderData(data);
  } catch (error) {
    showError('加载失败: ' + error.message);
  } finally {
    hideLoading();
  }
}
```

### 通知和提示

```javascript
// 成功提示
function showSuccess(message) {
  showNotification(message, 'success');
}

// 错误提示
function showError(message) {
  showNotification(message, 'error');
}

// 信息提示
function showInfo(message) {
  showNotification(message, 'info');
}

// 通用通知
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification--${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // 3秒后自动消失
  setTimeout(() => {
    notification.classList.add('notification--fade-out');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
```

```css
/* 通知样式 */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 4px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 9999;
  animation: slideIn 0.3s ease;
}

.notification--success {
  background-color: #4CAF50;
  color: white;
}

.notification--error {
  background-color: #f44336;
  color: white;
}

.notification--info {
  background-color: #2196F3;
  color: white;
}

.notification--fade-out {
  animation: fadeOut 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes fadeOut {
  to {
    opacity: 0;
  }
}
```

## 列表和表格

### 动态列表

参考 [smart-search-extension/history.js](mdc:smart-search-extension/history.js)

```javascript
// 渲染列表
function renderList(items) {
  const container = document.querySelector('#list-container');
  
  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state">暂无数据</div>';
    return;
  }
  
  const html = items.map(item => `
    <div class="list-item" data-id="${item.id}">
      <div class="list-item__header">
        <h3 class="list-item__title">${escapeHtml(item.title)}</h3>
        <span class="list-item__date">${formatDate(item.date)}</span>
      </div>
      <div class="list-item__content">
        <a href="${escapeHtml(item.url)}" target="_blank">${escapeHtml(item.url)}</a>
      </div>
      <div class="list-item__actions">
        <button class="btn btn--sm view-btn" data-id="${item.id}">查看</button>
        <button class="btn btn--sm btn--danger delete-btn" data-id="${item.id}">删除</button>
      </div>
    </div>
  `).join('');
  
  container.innerHTML = html;
}

// 转义 HTML 防止 XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 格式化日期
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}
```

### 表格渲染

```javascript
// 渲染表格
function renderTable(data) {
  const tbody = document.querySelector('#data-table tbody');
  
  const html = data.map(row => `
    <tr data-id="${row.id}">
      <td>${escapeHtml(row.name)}</td>
      <td>${escapeHtml(row.value)}</td>
      <td>${formatDate(row.date)}</td>
      <td>
        <button class="btn btn--sm edit-btn" data-id="${row.id}">编辑</button>
        <button class="btn btn--sm btn--danger delete-btn" data-id="${row.id}">删除</button>
      </td>
    </tr>
  `).join('');
  
  tbody.innerHTML = html;
}
```

### 分页

```javascript
class Paginator {
  constructor(items, itemsPerPage = 10) {
    this.items = items;
    this.itemsPerPage = itemsPerPage;
    this.currentPage = 1;
    this.totalPages = Math.ceil(items.length / itemsPerPage);
  }
  
  getCurrentPageItems() {
    const start = (this.currentPage - 1) * this.itemsPerPage;
    const end = start + this.itemsPerPage;
    return this.items.slice(start, end);
  }
  
  goToPage(page) {
    if (page < 1 || page > this.totalPages) return;
    this.currentPage = page;
    return this.getCurrentPageItems();
  }
  
  nextPage() {
    return this.goToPage(this.currentPage + 1);
  }
  
  prevPage() {
    return this.goToPage(this.currentPage - 1);
  }
}

// 使用
const paginator = new Paginator(allItems, 20);
renderList(paginator.getCurrentPageItems());
renderPagination(paginator);

function renderPagination(paginator) {
  const container = document.querySelector('#pagination');
  
  const html = `
    <button class="btn" ${paginator.currentPage === 1 ? 'disabled' : ''} id="prev-btn">上一页</button>
    <span>第 ${paginator.currentPage} / ${paginator.totalPages} 页</span>
    <button class="btn" ${paginator.currentPage === paginator.totalPages ? 'disabled' : ''} id="next-btn">下一页</button>
  `;
  
  container.innerHTML = html;
  
  document.querySelector('#prev-btn').addEventListener('click', () => {
    const items = paginator.prevPage();
    if (items) renderList(items);
    renderPagination(paginator);
  });
  
  document.querySelector('#next-btn').addEventListener('click', () => {
    const items = paginator.nextPage();
    if (items) renderList(items);
    renderPagination(paginator);
  });
}
```

## 搜索和过滤

```javascript
// 搜索功能
function setupSearch() {
  const searchInput = document.querySelector('#search');
  let searchTimeout;
  
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    
    // 防抖：300ms 后执行搜索
    searchTimeout = setTimeout(() => {
      const keyword = e.target.value.trim().toLowerCase();
      performSearch(keyword);
    }, 300);
  });
}

// 执行搜索
function performSearch(keyword) {
  if (!keyword) {
    renderList(allItems);
    return;
  }
  
  const filtered = allItems.filter(item => {
    return item.title.toLowerCase().includes(keyword) ||
           item.url.toLowerCase().includes(keyword) ||
           item.content.toLowerCase().includes(keyword);
  });
  
  renderList(filtered);
  updateSearchStats(filtered.length, allItems.length);
}

// 更新搜索统计
function updateSearchStats(matchCount, totalCount) {
  const stats = document.querySelector('#search-stats');
  stats.textContent = `找到 ${matchCount} / ${totalCount} 条记录`;
}

// 多条件过滤
function setupFilters() {
  const dateFilter = document.querySelector('#date-filter');
  const typeFilter = document.querySelector('#type-filter');
  
  const applyFilters = () => {
    let filtered = [...allItems];
    
    // 日期过滤
    const dateValue = dateFilter.value;
    if (dateValue) {
      filtered = filtered.filter(item => item.date === dateValue);
    }
    
    // 类型过滤
    const typeValue = typeFilter.value;
    if (typeValue && typeValue !== 'all') {
      filtered = filtered.filter(item => item.type === typeValue);
    }
    
    renderList(filtered);
  };
  
  dateFilter.addEventListener('change', applyFilters);
  typeFilter.addEventListener('change', applyFilters);
}
```

## 性能优化

### 虚拟滚动（大列表）

```javascript
// 虚拟滚动实现（简化版）
class VirtualList {
  constructor(container, items, rowHeight = 50) {
    this.container = container;
    this.items = items;
    this.rowHeight = rowHeight;
    this.visibleRows = Math.ceil(container.clientHeight / rowHeight);
    this.startIndex = 0;
    
    this.setupScroll();
    this.render();
  }
  
  setupScroll() {
    this.container.addEventListener('scroll', () => {
      const scrollTop = this.container.scrollTop;
      const newStartIndex = Math.floor(scrollTop / this.rowHeight);
      
      if (newStartIndex !== this.startIndex) {
        this.startIndex = newStartIndex;
        this.render();
      }
    });
  }
  
  render() {
    const endIndex = Math.min(
      this.startIndex + this.visibleRows + 5, // 多渲染几行
      this.items.length
    );
    
    const visibleItems = this.items.slice(this.startIndex, endIndex);
    
    // 设置容器高度（模拟完整列表）
    const totalHeight = this.items.length * this.rowHeight;
    this.container.style.height = totalHeight + 'px';
    
    // 渲染可见项
    const html = visibleItems.map((item, index) => {
      const actualIndex = this.startIndex + index;
      const top = actualIndex * this.rowHeight;
      
      return `
        <div class="list-item" style="position: absolute; top: ${top}px; height: ${this.rowHeight}px;">
          ${renderItem(item)}
        </div>
      `;
    }).join('');
    
    this.container.innerHTML = html;
  }
}
```

### 懒加载图片

```javascript
// 图片懒加载
function setupLazyImages() {
  const images = document.querySelectorAll('img[data-src]');
  
  const imageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(img => imageObserver.observe(img));
}

// HTML 中使用
// <img data-src="real-image.jpg" src="placeholder.jpg" alt="描述">
```

## 可访问性（A11y）

### 键盘导航

```javascript
// 支持键盘快捷键
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + S 保存
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveSettings();
  }
  
  // Esc 关闭弹窗
  if (e.key === 'Escape') {
    closeModal();
  }
  
  // / 聚焦搜索框
  if (e.key === '/' && !e.target.matches('input, textarea')) {
    e.preventDefault();
    document.querySelector('#search').focus();
  }
});
```

### ARIA 属性

```html
<!-- 按钮状态 -->
<button aria-pressed="false" id="toggle-btn">切换</button>

<!-- 加载状态 -->
<button aria-busy="true">加载中...</button>

<!-- 禁用状态 -->
<button disabled aria-disabled="true">不可用</button>

<!-- 展开/收起 -->
<button aria-expanded="false" aria-controls="content">展开</button>
<div id="content" aria-hidden="true">内容</div>

<!-- 表单标签 -->
<label for="email">邮箱</label>
<input type="email" id="email" aria-required="true" aria-invalid="false">
<span role="alert" aria-live="polite" id="email-error"></span>
```

## 调试和测试

### 添加调试信息

```javascript
// 开发模式检测
const DEBUG = !('update_url' in chrome.runtime.getManifest());

// 调试日志
function debug(...args) {
  if (DEBUG) {
    console.log('[UI Debug]', ...args);
  }
}

// 性能监控
function measurePerformance(name, fn) {
  const start = performance.now();
  const result = fn();
  const duration = performance.now() - start;
  
  debug(`${name} took ${duration.toFixed(2)}ms`);
  return result;
}

// 使用
measurePerformance('Render List', () => {
  renderList(items);
});
```

### UI 测试

参考 [tests/integration/history-ui.test.js](mdc:tests/integration/history-ui.test.js)

```javascript
describe('历史记录 UI 测试', () => {
  beforeEach(() => {
    document.body.innerHTML = `
      <div id="list-container"></div>
      <div id="search-container">
        <input id="search" type="text">
      </div>
    `;
  });
  
  test('应该能够渲染列表', () => {
    const items = [
      { id: 1, title: 'Test', url: 'https://example.com' }
    ];
    
    renderList(items);
    
    const listItems = document.querySelectorAll('.list-item');
    expect(listItems.length).toBe(1);
    expect(listItems[0].querySelector('.list-item__title').textContent).toBe('Test');
  });
  
  test('应该能够搜索', async () => {
    const searchInput = document.querySelector('#search');
    searchInput.value = 'test';
    searchInput.dispatchEvent(new Event('input'));
    
    // 等待防抖
    await new Promise(resolve => setTimeout(resolve, 350));
    
    // 验证搜索结果
  });
});
```

## 常见问题

### 问题：样式冲突

**解决**：使用更具体的选择器或 CSS 模块

```css
/* 使用更具体的选择器 */
.extension-popup .button { }

/* 或使用 ID */
#extension-settings .button { }
```

### 问题：XSS 安全问题

**解决**：始终转义用户输入

```javascript
// ✅ 正确
element.textContent = userInput; // 自动转义

// ✅ 正确
element.innerHTML = escapeHtml(userInput);

// ❌ 错误
element.innerHTML = userInput; // XSS 风险！
```

## 参考文件

- [options.html](mdc:smart-search-extension/options.html) - 设置页面
- [options.js](mdc:smart-search-extension/options.js) - 设置逻辑
- [history.html](mdc:smart-search-extension/history.html) - 历史记录页面
- [history.js](mdc:smart-search-extension/history.js) - 历史记录逻辑
