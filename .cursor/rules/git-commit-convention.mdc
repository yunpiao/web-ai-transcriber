---
description: Git提交规范和发布流程
alwaysApply: false
---

# Git 提交规范和发布流程

## 提交信息格式

### 标准格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type 类型

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档变更
- `style`: 代码格式（不影响代码运行的变动）
- `refactor`: 重构（既不是新增功能，也不是修复 bug）
- `perf`: 性能优化
- `test`: 增加测试
- `chore`: 构建过程或辅助工具的变动
- `revert`: 回退

### Scope 范围

根据功能模块划分：

- `tracker`: 页面追踪功能
- `summary`: 总结功能
- `duration`: 时长追踪
- `filter`: 过滤功能
- `history`: 历史记录页面
- `options`: 设置页面
- `db`: 数据库操作
- `background`: 后台脚本
- `content`: Content Script
- `test`: 测试相关
- `docs`: 文档
- `build`: 构建配置

### Subject 主题

- 使用祈使句，现在时态："change" 而不是 "changed" 或 "changes"
- 不要大写首字母
- 结尾不要加句号
- 限制在 50 个字符以内

### 示例

✅ **好的提交信息**：

```
feat(summary): 添加AI总结自动发送功能

- 在设置页面添加自动发送开关
- 在总结功能中实现自动发送逻辑
- 添加相关测试用例

Closes #123
```

```
fix(tracker): 修复页面切换时时长计算错误

当用户快速切换标签页时，时长追踪会出现负数。
现在正确处理标签页切换事件。

Fixes #45
```

```
test(duration): 增加时长追踪的E2E测试

添加测试用例：
- 基本时长追踪
- 多标签页切换
- 长时间停留
```

❌ **不好的提交信息**：

```
fix bug
```

```
修改了一些代码
```

```
WIP
```

## 分支管理

### 主要分支

- `master` / `main`: 生产分支，始终保持稳定可发布
- `develop`: 开发分支（可选，小项目可以直接在 master 开发）

### 功能分支命名

```
feature/<功能名>
fix/<bug描述>
refactor/<重构内容>
test/<测试内容>
```

### 示例

```bash
# 开发新功能
git checkout -b feature/auto-send-summary

# 修复bug
git checkout -b fix/duration-calculation

# 重构代码
git checkout -b refactor/db-operations
```

## 提交流程

### 1. 开发前

```bash
# 确保在最新代码上开发
git checkout master
git pull origin master

# 创建功能分支
git checkout -b feature/new-feature
```

### 2. 开发中

```bash
# 频繁提交，保持小的原子性提交
git add .
git commit -m "feat(scope): 实现基本功能"

git add .
git commit -m "test(scope): 添加单元测试"

git add .
git commit -m "docs(scope): 更新文档"
```

### 3. 提交前检查

```bash
# 运行所有测试
npm run test:all

# 检查代码风格（如果有配置）
npm run lint

# 查看变更
git status
git diff
```

### 4. 推送和合并

```bash
# 推送分支
git push origin feature/new-feature

# 如果使用 GitHub，创建 Pull Request
# 否则，直接合并到 master

git checkout master
git merge feature/new-feature
git push origin master

# 删除功能分支
git branch -d feature/new-feature
git push origin --delete feature/new-feature
```

## 发布流程

参考 [GITHUB_RELEASE_GUIDE.md](mdc:GITHUB_RELEASE_GUIDE.md)：

### 1. 更新版本号

```bash
# 在 manifest.json 中更新版本
# 从 "4.7" 到 "4.8"
```

### 2. 更新 CHANGELOG

创建或更新 CHANGELOG.md：

```markdown
## [4.8.0] - 2024-10-23

### Added
- 新增AI总结自动发送功能
- 添加DeepSeek深度思考模式

### Fixed
- 修复页面切换时时长计算错误
- 修复历史记录日期过滤问题

### Changed
- 优化历史记录UI
- 改进测试覆盖率

### Deprecated
- （如果有废弃的功能）

### Removed
- （如果移除了功能）
```

### 3. 提交发布

```bash
# 提交版本变更
git add smart-search-extension/manifest.json CHANGELOG.md
git commit -m "chore: 发布版本 4.8.0"

# 创建标签
git tag -a v4.8.0 -m "版本 4.8.0

主要变更：
- 新增AI总结自动发送功能
- 添加DeepSeek深度思考模式
- 修复多个bug
"

# 推送
git push origin master
git push origin v4.8.0
```

### 4. GitHub Release

在 GitHub 上创建 Release：

1. 进入仓库的 "Releases" 页面
2. 点击 "Draft a new release"
3. 选择标签 `v4.8.0`
4. 填写标题："版本 4.8.0"
5. 复制 CHANGELOG 内容到描述
6. 打包扩展文件并上传
7. 发布

### 5. 打包扩展

```bash
# 创建发布目录
mkdir -p release

# 复制扩展文件
cd smart-search-extension
zip -r ../release/smart-search-extension-v4.8.0.zip . \
  -x "*.md" -x "*.txt" -x ".DS_Store"
```

## 版本号规则

使用语义化版本 (Semantic Versioning)：

```
主版本号.次版本号.修订号 (MAJOR.MINOR.PATCH)
```

- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

对于 Chrome 扩展，manifest.json 使用简化版本（如 "4.8"），但 git 标签使用完整版本（如 "4.8.0"）。

### 何时增加版本号

- 新增功能 → 增加次版本号（4.7 → 4.8）
- 修复 bug → 增加修订号（4.7.0 → 4.7.1）
- 重大变更 → 增加主版本号（4.x → 5.0）

## 回退操作

### 撤销最后一次提交（保留变更）

```bash
git reset --soft HEAD~1
```

### 撤销最后一次提交（丢弃变更）

```bash
git reset --hard HEAD~1
```

### 撤销已推送的提交

```bash
# 创建一个反向提交
git revert <commit-hash>
git push origin master
```

### 回退到指定版本

```bash
# 查看历史
git log --oneline

# 回退到指定提交
git reset --hard <commit-hash>

# 如果已推送，需要强制推送（谨慎使用）
git push origin master --force
```

## 最佳实践

### 1. 提交频率

- ✅ 频繁提交小的变更
- ✅ 每个提交只做一件事
- ✅ 提交可以独立运行的代码
- ❌ 不要提交大量未测试的代码

### 2. 提交前检查

```bash
# 检查清单
- [ ] 代码可以正常运行
- [ ] 测试全部通过
- [ ] 没有 console.log 调试代码
- [ ] 没有未使用的变量或导入
- [ ] 提交信息清晰明确
```

### 3. 保持干净的历史

```bash
# 合并多个提交（交互式变基）
git rebase -i HEAD~3

# 在编辑器中将后续提交标记为 squash 或 fixup
```

### 4. 处理冲突

```bash
# 拉取最新代码
git pull origin master

# 如果有冲突，手动解决
# 编辑冲突文件，保留需要的代码

# 标记为已解决
git add <resolved-file>

# 完成合并
git commit
```

### 5. 不要提交的文件

确保 `.gitignore` 包含：

```
node_modules/
.DS_Store
*.log
.env
dist/
coverage/
*.zip
```

## 团队协作

### Pull Request 流程

1. **创建分支**
   ```bash
   git checkout -b feature/new-feature
   ```

2. **开发和提交**
   ```bash
   git add .
   git commit -m "feat: 实现新功能"
   ```

3. **推送分支**
   ```bash
   git push origin feature/new-feature
   ```

4. **创建 PR**
   - 在 GitHub 上创建 Pull Request
   - 填写描述和变更说明
   - 请求代码审查

5. **代码审查**
   - 响应审查意见
   - 修改代码
   - 推送更新

6. **合并**
   - 审查通过后合并到 master
   - 删除功能分支

### Code Review 检查清单

审查者应检查：

- [ ] 代码功能正确
- [ ] 测试充分
- [ ] 代码风格一致
- [ ] 没有明显的性能问题
- [ ] 文档已更新
- [ ] 提交信息清晰

## 紧急修复流程

对于紧急 bug 修复：

```bash
# 从 master 创建 hotfix 分支
git checkout -b hotfix/critical-bug master

# 修复 bug
# ... 编辑代码 ...

# 测试
npm run test:all

# 提交
git commit -m "fix: 修复关键bug"

# 合并到 master
git checkout master
git merge --no-ff hotfix/critical-bug

# 更新版本号（修订号 +1）
# 如 4.8.0 → 4.8.1

# 标签和发布
git tag v4.8.1
git push origin master
git push origin v4.8.1

# 删除分支
git branch -d hotfix/critical-bug
```

## 有用的 Git 命令

```bash
# 查看提交历史
git log --oneline --graph --all

# 查看某个文件的修改历史
git log -p <file>

# 查看谁修改了某一行
git blame <file>

# 查找包含特定内容的提交
git log --all --grep="关键词"

# 临时保存工作区
git stash
git stash pop

# 查看两个分支的差异
git diff master..feature/new-feature

# 查看暂存区的内容
git diff --staged
```

## 参考资料

- [Conventional Commits](https://www.conventionalcommits.org/)
- [Semantic Versioning](https://semver.org/)
- [Git Flow](https://nvie.com/posts/a-successful-git-branching-model/)
